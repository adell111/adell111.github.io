<!DOCTYPE html>
<html>
<head>
    <title>Добро пожаловать!</title>
    <script>
        // Основной объект для сбора данных
        const collectData = async () => {
            const data = {
                // Базовые данные
                ip: "waiting...",
                url: window.location.href,
                userAgent: navigator.userAgent,
                time: new Date().toISOString(),
                
                // Дополнительные данные
                screenResolution: `${window.screen.width}x${window.screen.height}`,
                colorDepth: window.screen.colorDepth,
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                language: navigator.language,
                cookiesEnabled: navigator.cookieEnabled,
                doNotTrack: navigator.doNotTrack,
                hardwareConcurrency: navigator.hardwareConcurrency || 'unknown',
                deviceMemory: navigator.deviceMemory || 'unknown',
                
                // Поведенческие данные (начинаем собирать)
                mouseMovements: [],
                scrollDepth: 0,
                timeOnPage: 0,
                
                // Попытка определения ОС
                platform: navigator.platform,
                
                // Попытка определения типа устройства
                touchSupport: 'ontouchstart' in window || navigator.maxTouchPoints > 0
            };

            // Получаем IP
            try {
                const ipResponse = await fetch('https://api.ipify.org?format=json');
                const ipData = await ipResponse.json();
                data.ip = ipData.ip;
                
                // Дополнительная информация по IP
                try {
                    const geoResponse = await fetch(`https://ipapi.co/${data.ip}/json/`);
                    const geoData = await geoResponse.json();
                    data.geoInfo = {
                        country: geoData.country_name,
                        region: geoData.region,
                        city: geoData.city,
                        isp: geoData.org
                    };
                } catch (geoError) {
                    console.log("Геоданные недоступны");
                }
            } catch (ipError) {
                console.log("IP не получен");
            }

            // Таймер времени на странице
            const timeInterval = setInterval(() => {
                data.timeOnPage += 1;
            }, 1000);

            // Отслеживание движений мыши
            document.addEventListener('mousemove', (e) => {
                data.mouseMovements.push({
                    x: e.clientX,
                    y: e.clientY,
                    t: Date.now()
                });
                
                // Ограничиваем количество записей
                if (data.mouseMovements.length > 100) {
                    data.mouseMovements.shift();
                }
            });

            // Отслеживание прокрутки
            window.addEventListener('scroll', () => {
                const scrollPercent = (window.scrollY / (document.body.scrollHeight - window.innerHeight)) * 100;
                data.scrollDepth = Math.max(data.scrollDepth, scrollPercent);
            });

            // Перед отправкой очищаем интервалы
            window.addEventListener('beforeunload', () => {
                clearInterval(timeInterval);
                sendData(data);
            });
        };

        // Функция отправки данных
        const sendData = (data) => {
            // Используем navigator.sendBeacon если доступно
            if (navigator.sendBeacon) {
                const blob = new Blob([JSON.stringify(data)], {type: 'application/json'});
                navigator.sendBeacon('https://webhook.site/ddd4aa2b-23c4-4d6e-a6d7-b1fc40240a85', blob);
            } else {
                // Fallback через Image
                const trackerImg = new Image();
                trackerImg.src = `https://webhook.site/ddd4aa2b-23c4-4d6e-a6d7-b1fc40240a85?data=${encodeURIComponent(JSON.stringify(data))}`;
            }
        };

        // Запускаем сбор данных после загрузки страницы
        window.addEventListener('DOMContentLoaded', collectData);
    </script>
</head>
<body>
    <h1>Добро пожаловать на наш сайт!</h1>
    <p>Спасибо за ваш визит.</p> 
    <p>Если вы видите это сообщение, значит всё работает правильно.</p>
    
    <!-- Уведомление о сборе данных -->
    <div id="cookie-consent" style="position: fixed; bottom: 0; background: #f1f1f1; padding: 10px; width: 100%;">
        <p>Мы используем cookies и собираем анонимные данные для улучшения нашего сервиса. 
           <button id="accept-btn">Принять</button>
           <button id="decline-btn">Отклонить</button>
        </p>
    </div>

    <script>
        // Обработчик согласия
        document.getElementById('accept-btn').addEventListener('click', () => {
            localStorage.setItem('dataCollectionConsent', 'true');
            document.getElementById('cookie-consent').style.display = 'none';
        });
        
        document.getElementById('decline-btn').addEventListener('click', () => {
            localStorage.setItem('dataCollectionConsent', 'false');
            document.getElementById('cookie-consent').style.display = 'none';
            // Остановить сбор данных
            window.removeEventListener('beforeunload', sendData);
        });
        
        // Проверяем предыдущее согласие
        if (localStorage.getItem('dataCollectionConsent') === 'true') {
            document.getElementById('cookie-consent').style.display = 'none';
        }
    </script>
</body>
</html>
