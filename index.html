<!DOCTYPE html>
<html>
<head>
    <title>Аналитика посещений</title>
    <style>
        #debug-output {
            font-family: monospace;
            background: #f5f5f5;
            padding: 10px;
            margin-top: 20px;
            border-radius: 5px;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>Добро пожаловать!</h1>
    <p>Идёт сбор основных данных...</p>
    
    <div id="debug-output"></div>

    <script>
        // Элемент для отладки
        const debugEl = document.getElementById('debug-output');
        
        // Логирование в консоль и на страницу
        function debugLog(message) {
            console.log('[DEBUG]', message);
            debugEl.innerHTML += `<p>${new Date().toLocaleTimeString()}: ${message}</p>`;
        }

        // Получение IP через CORS-совместимый сервис
        async function getIP() {
            try {
                debugLog("Получаем IP адрес...");
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch (error) {
                debugLog("Ошибка получения IP: " + error.message);
                return "unknown";
            }
        }

        // Получение геоданных через прокси-сервис
        async function getGeoData(ip) {
            if (ip === "unknown") return null;
            
            try {
                debugLog("Запрашиваем геоданные...");
                const response = await fetch(`https://ipapi.co/${ip}/json/`);
                if (!response.ok) throw new Error("API не отвечает");
                return await response.json();
            } catch (error) {
                debugLog("Ошибка геоданных: " + error.message);
                return null;
            }
        }

        // Отправка данных на webhook
        async function sendToWebhook(data) {
            const webhookUrl = 'https://webhook.site/ddd4aa2b-23c4-4d6e-a6d7-b1fc40240a85';
            
            try {
                debugLog("Отправляем данные...");
                const response = await fetch(webhookUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                debugLog(`Данные отправлены (статус: ${response.status})`);
            } catch (error) {
                debugLog("Ошибка отправки: " + error.message);
            }
        }

        // Основная функция
        async function collectData() {
            const ip = await getIP();
            const geoData = await getGeoData(ip);
            
            const collectedData = {
                meta: {
                    timestamp: new Date().toISOString(),
                    url: window.location.href
                },
                device: {
                    ip: ip,
                    userAgent: navigator.userAgent,
                    screen: `${window.screen.width}x${window.screen.height}`,
                    language: navigator.language,
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                    cookies: navigator.cookieEnabled ? "enabled" : "disabled"
                },
                location: geoData ? {
                    country: geoData.country_name,
                    region: geoData.region,
                    city: geoData.city,
                    isp: geoData.org
                } : null
            };

            debugLog("Собранные данные: " + JSON.stringify(collectedData, null, 2));
            await sendToWebhook(collectedData);
        }

        // Запускаем при загрузке страницы
        window.addEventListener('DOMContentLoaded', collectData);
    </script>
</body>
</html>
